{% extends "layout.html" %} {% block css %} {% endblock %}
{% block content %}
<style>
    .b_inner .contents_box {
        float: none;
        display: flex;
        justify-content: center;
    }

    .contents {
        max-width: 933px;
        display: flex;
        border: 1px solid rgba(0, 0, 0, .0975);
        border-radius: 3px;
        background: #fff;
    }

    .contents .img_section {
        overflow: hidden;
        max-width: 598px;
        border-right: 1px solid rgba(0, 0, 0, .0975);

    }

    .contents .img_section .trans_inner {
        /*width: 2448px;*/
        font-size: 0;
    }

    .contents .img_section .trans_inner>div {
        width: 100%;
        display: inline-block;
    }

    .contents .img_section .trans_inner img {
        width: 100%;
        height: 100%;
    }

    .sprite_more_icon.on .more_detail {
        /*display: block;*/
        transform: scale(1);


    }

    .top .more_detail>li {
        padding: 10px 20px;
        cursor: pointer;
    }

    .top .more_detail>li:hover {
        background: gray;
    }

    .user_container .country {
        font-size: 12px;
    }

    .contents .img_section {
        overflow: hidden;
    }

    .contents .img_section .trans_inner {
        /*width: 2448px;*/
        font-size: 0;
    }

    .contents .img_section .trans_inner>div {
        width: 100%;
        display: inline-block;
    }

    .contents .img_section .trans_inner img {
        width: 100%;
        height: 100%;
    }

    .detail--right_box {
        max-width: 335px;
        width: 100%;
    }


    .detail--right_box .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 13px 17px;
        position: relative;

        border-bottom: 1px solid rgba(0, 0, 0, .0975);
    }

    .detail--right_box .top .sprite_more_icon {
        cursor: pointer;
        padding: 5px 5px;
    }

    .post_form {
        padding: 40px;
        background-color: #fff;
        border: 1px solid #e6e6e6;
        margin: 0 0 10px;
    }

    .post_form .title {
        margin: 0 10px 40px;
        font-weight: 400;
        font-size: 30px;
        text-align: center;
    }


    .post_form .preview {
        margin-bottom: 30px;
    }

    .post_form .preview .upload {
        max-width: 300px;
        height: 300px;
        border: 1px solid #e6e6e6;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .plus_icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 10px;
        border: 1px solid dodgerblue;
        display: flex;
        justify-content: center;
        align-items: center;
    }


    .plus_icon span {
        position: absolute;
        display: block;
        width: 2px;
        height: 30px;
        background: dodgerblue;

    }

    .plus_icon span:nth-child(2) {
        transform: rotate(90deg);
    }

    .post_form p {
        margin-bottom: 20px;
    }

    .post_form input[type=file] {
        width: 100%;
        background: 0 0;
        border: 1px solid #efefef;
        border-radius: 3px;
        box-sizing: border-box;
        color: #262626;
        font-size: 14px;
        padding: 7px 8px 7px;
    }


    .post_form textarea {
        width: 100%;
        background: 0 0;
        border: 1px solid #efefef;
        border-radius: 3px;
        box-sizing: border-box;
        color: #262626;
        font-size: 14px;
        padding: 7px 8px 7px;
    }



    .submit_btn {
        background: #3897f0;
        border-color: #3897f0;
        color: #fff;
        border-radius: 3px;
        border-style: solid;
        border-width: 1px;
        font-size: 14px;
        font-weight: 600;
        line-height: 28px;
        outline: none;
        width: 100%;
        padding: 0;
        margin-top: 10px;
    }

    .club-table img {
        width: 100px;
        height: 100px;
    }

    .club-table {
        border: 1px solid red;
        margin-bottom: 10px;
    }
</style>
<section class="community-view-box">
    <div class="title">상세페이지</div>
    <div id="club-list">
    </div>
</section>
{% endblock %}
{% block script %}
<script>
    clubDetail();
    async function clubDetail() {
        try {
            const rawdata = await axios.get("/clubdetail/comment");
            const clubdata = await rawdata.data
            const listbody = document.querySelector('#club-list');
            listbody.innerHTML = "";

            clubdata.map(async function (club) {
                // 로우 셀 추가
                const clubTable = document.createElement('div');
                clubTable.setAttribute("class", "club-table");
                let row = document.createElement('div');
                row.textContent = club.User.nick;
                clubTable.appendChild(row);

                let img = document.createElement('img');
                img.setAttribute("src", `${club.img}`)
                clubTable.appendChild(img);

                row = document.createElement('div');
                row.textContent = club.content;
                clubTable.appendChild(row);

                const commentsList = await club.ClubComments;

                commentsList.map(function (comment) {
                    const comentsTable = document.createElement('div');
                    comentsTable.setAttribute("class", "user-comment-table");

                    let commentrow = document.createElement('div');
                    commentrow.textContent = comment.User.nick;
                    comentsTable.appendChild(commentrow);


                    const editForm = document.createElement('form');
                    editForm.addEventListener('submit', async (e) => {
                        if (document.querySelector("#my-id") !== null) {
                            e.preventDefault();
                            const editid = comment.id;
                            id = editid;
                            comment = e.target.comment.value;
                            editComment(id, comment)
                        }
                    });
                    editForm.setAttribute("class", "edit-form");
                    commentrow.appendChild(editForm);

                    commentrow = document.createElement('input');
                    commentrow.setAttribute("readonly", "");
                    commentrow.setAttribute("type", "text");
                    commentrow.setAttribute("name", "comment");
                    commentrow.value = comment.comment;
                    editForm.appendChild(commentrow);
                    if (document.querySelector("#my-id") !== null && document.querySelector("#my-id").value == comment.User.id) {
                        let commentEdit = document.createElement('button');
                        commentEdit.setAttribute("type", "button");
                        commentEdit.textContent = "수정";
                        editForm.appendChild(commentEdit);
                        commentEdit.addEventListener('click', async (e) => {
                            try {
                                const prevTag = e.target.previousSibling;
                                e.target.setAttribute("hidden", "");
                                prevTag.removeAttribute("readonly");
                                let commentEditCheck = document.createElement('button');
                                commentEditCheck.setAttribute("type", "submit");
                                commentEditCheck.textContent = "수정확인"
                                editForm.appendChild(commentEditCheck);

                                commentEditCheck = document.createElement('button');
                                commentEditCheck.setAttribute("type", "button")
                                commentEditCheck.textContent = "취소"
                                commentEditCheck.addEventListener('click', async (e) => {
                                    clubDetail();
                                });
                                editForm.appendChild(commentEditCheck);

                                // await axios.patch(`/clubdetail/edit/${comment.id}`);
                                // const editCommentInput = document.createElement('input');
                                // editCommentInput.setAttribute("id", "edit-comment-input");
                                // editCommentInput.textContent = "//////////////////////////////////////////"
                                console.log(prevTag)
                            } catch (err) {
                                console.error(err);
                            }
                        });


                        commentDelete = document.createElement('button');
                        commentDelete.textContent = "삭제";
                        editForm.appendChild(commentDelete);
                        commentDelete.addEventListener('click', async () => { // 삭제 클릭 시
                            try {
                                await axios.delete(`/clubdetail/delete/${comment.id}`);
                                clubDetail();
                            } catch (err) {
                                console.error(err);
                            }
                        });
                    }

                    clubTable.appendChild(comentsTable);
                });
                if (document.querySelector("#my-id") !== null) {
                    const myId = document.querySelector("#my-id").value
                    row = document.createElement('div');
                    row.textContent = "//////댓글작성창을 아래에 넣는다//////";
                    clubTable.appendChild(row);

                    const inputForm = document.createElement('form');
                    inputForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const clubId = club.id;
                        const writerId = myId;
                        const comment = e.target.comment.value;
                        inputComment(clubId, writerId, comment)
                        e.target.comment.value = '';
                    });
                    inputForm.setAttribute("class", "input-form");
                    clubTable.appendChild(inputForm);

                    let inputItem = document.createElement('input');
                    inputItem.setAttribute("type", "text");
                    inputItem.setAttribute("name", "comment");
                    inputForm.appendChild(inputItem);

                    let commentInputCheck = document.createElement('button');
                    commentInputCheck.setAttribute("class", "input-button");
                    commentInputCheck.setAttribute("type", "submit");
                    commentInputCheck.textContent = "확인"
                    inputForm.appendChild(commentInputCheck);

                    commentInputCheck = document.createElement('button');
                    commentInputCheck.setAttribute("type", "button");
                    commentInputCheck.textContent = "취소"
                    commentInputCheck.addEventListener('click', async (e) => {
                        clubDetail();
                    });
                    inputForm.appendChild(commentInputCheck);

                };
                listbody.appendChild(clubTable);
            });
        } catch (err) {
            console.error(err);
        }
    };

    async function inputComment(clubId, writerId, comment) {
        console.log(clubId);
        clubId = clubId;
        writerId = writerId;
        comment = comment;
        try {
            await axios.post('/clubdetail', { clubId, writerId, comment });
            clubDetail();
        } catch (err) {
            console.error(err);
        }
    }
    async function editComment(id, comment) {
        id = id;
        comment = comment;
        try {
            await axios.patch('/clubdetail/commentedit', { id, comment });
            clubDetail();
        } catch (err) {
            console.error(err);
        }
    }
</script>
{% endblock %}